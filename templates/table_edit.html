{% extends "base.html" %}

{% block title %}テーブルの定義編集: {{ table_name }} - Local DB MCP Server{% endblock %}

{% block content %}
<div class="container">
    <div class="nav">
        <a href="/">← ホームに戻る</a>
        <a href="/table/{{ table_name }}">← データ表示に戻る</a>
    </div>
    
    <h1>{{ table_name }} <span id="recordCount" class="record-count"></span> <button id="bulkSaveBtn" class="action-button" onclick="performBulkUpdate()" style="margin-left:8px;">一括更新</button></h1>
    <div id="editContent"></div>
    <div id="result"></div>
</div>

<script>
    const tableName = '{{ table_name }}';
    
    async function loadEditContent() {
        try {
            const response = await fetch(`/table/${tableName}/metadata`);
            const data = await response.json();
            
            // レコード数を表示
            document.getElementById('recordCount').textContent = `${data.row_count}レコード`;
            
            let html = '';
            
            // テーブル情報（テーブル名 + 説明を1つの表に統合）
            html += `<h4>テーブル情報</h4>`;
            html += `<table class=\"table-info-table\">
                        <tr><th>テーブル名</th><th>説明</th></tr>
                        <tr>
                            <td>
                                <input type=\"text\" id=\"newTableName\" value=\"${data.table || tableName}\" class=\"description-input\">
                            </td>
                            <td>
                                <input type=\"text\" id=\"tableComment\" placeholder=\"テーブルの説明を入力してください\" value=\"${data.table_comment || ''}\" class=\"description-input\">
                            </td>
                        </tr>
                    </table>`;
            
            html += '<h4>カラム一覧</h4>';
            html += '<table class="columns-table">';
            html += '<tr><th>カラム名</th><th>データ型</th><th>説明</th></tr>';

            for (let i = 0; i < data.columns.length; i++) {
                const column = data.columns[i];
                const idx = i;
                const safeComment = (column.comment || '').replace(/"/g, '&quot;');
                html += `<tr class="column-row" data-original-name="${column.name}">
                            <td>
                                <input type="text" id="col-name-${idx}" value="${column.name}" class="description-input" />
                            </td>
                            <td>${column.type}</td>
                            <td>
                                <input type="text" id="col-comment-${idx}" value="${safeComment}" class="description-input" />
                            </td>
                        </tr>`;
            }
            html += '</table>';
            
            document.getElementById('editContent').innerHTML = html;
        } catch (error) {
            document.getElementById('editContent').innerHTML = `<p>エラー: ${error.message}</p>`;
        }
    }
    
    function showResult(message, type) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
    }
    
    async function performBulkUpdate() {
        const resultArea = document.getElementById('result');
        function note(msg, type) { resultArea.innerHTML = `<div class=\"result ${type}\">${msg}</div>`; }

        let currentTableName = tableName;
        const desiredTableNameInput = document.getElementById('newTableName');
        const desiredTableName = desiredTableNameInput ? desiredTableNameInput.value.trim() : currentTableName;
        const commentInput = document.getElementById('tableComment');
        const desiredComment = commentInput ? commentInput.value : '';

        // カラム収集
        const rows = Array.from(document.querySelectorAll('.column-row'));
        const columns = rows.map((row, i) => {
            const originalName = row.getAttribute('data-original-name');
            const newName = (document.getElementById(`col-name-${i}`)?.value || '').trim();
            const newComment = document.getElementById(`col-comment-${i}`)?.value || '';
            return { originalName, newName, newComment };
        });

        try {
            // 1) カラム名の変更（必要なもののみ）
            for (const col of columns) {
                if (col.newName && col.newName !== col.originalName) {
                    const resp = await fetch(`/table/${encodeURIComponent(currentTableName)}/column/${encodeURIComponent(col.originalName)}?new_name=${encodeURIComponent(col.newName)}`, { method: 'PUT' });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'カラム名更新エラー');
                    // 後続処理では新しい名前を使う
                    col.effectiveName = col.newName;
                } else {
                    col.effectiveName = col.originalName;
                }
            }

            // 2) カラム説明の更新
            for (const col of columns) {
                const resp = await fetch(`/table/${encodeURIComponent(currentTableName)}/column/${encodeURIComponent(col.effectiveName)}/comment?comment=${encodeURIComponent(col.newComment)}`, { method: 'PUT' });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'カラム説明更新エラー');
            }

            // 3) テーブル説明の更新
            if (commentInput) {
                const resp = await fetch(`/table/${encodeURIComponent(currentTableName)}/comment?comment=${encodeURIComponent(desiredComment)}`, { method: 'PUT' });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'テーブル説明更新エラー');
            }

            // 4) テーブル名の変更（最後に）
            if (desiredTableName && desiredTableName !== currentTableName) {
                const resp = await fetch(`/table/${encodeURIComponent(currentTableName)}/rename`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: desiredTableName })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.detail ? data.detail : 'テーブル名更新エラー');
                note(`✅ すべて更新しました。遷移します…`, 'success');
                window.location.href = `/table/${encodeURIComponent(desiredTableName)}/edit`;
                return;
            }

            note('✅ すべて更新しました', 'success');
            loadEditContent();
        } catch (e) {
            note(`❌ エラー: ${e.message}`, 'error');
        }
    }
    
    // ページ読み込み時に編集内容を表示
    loadEditContent();
</script>
{% endblock %}
