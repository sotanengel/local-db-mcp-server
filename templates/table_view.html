{% extends "base.html" %}

{% block title %}テーブル表示: {{ table_name }} - Local DB MCP Server{% endblock %}

{% block content %}
<div class="container">
    <div class="nav">
        <a href="/">← ホームに戻る</a>
        <button onclick="editTable('{{ table_name }}')">テーブルの定義を編集</button>
    </div>
    
    <h1>{{ table_name }} テーブル</h1>
    
    <!-- テーブル定義セクション -->
    <div class="table-definition-section">
        <h3 class="collapsible-header" onclick="toggleTableDefinition()">
            <span id="definitionToggle">▼</span> テーブル定義
        </h3>
        <div id="tableDefinition" class="collapsible-content" style="display: none;">
            <div id="definitionContent"></div>
        </div>
    </div>
    
    <!-- データセクション -->
    <div class="data-section">
        <h3 class="data-header">データ (最初の100行)</h3>
        <div id="tableData"></div>
    </div>
    
    <div id="result"></div>
</div>

<script>
    const tableName = '{{ table_name }}';
    
    // テーブル定義の表示/非表示切り替え
    function toggleTableDefinition() {
        const content = document.getElementById('tableDefinition');
        const toggle = document.getElementById('definitionToggle');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            toggle.textContent = '▲';
            loadTableDefinition();
        } else {
            content.style.display = 'none';
            toggle.textContent = '▼';
        }
    }
    
    // テーブル定義の読み込み
    async function loadTableDefinition() {
        try {
            const response = await fetch(`/table/${tableName}/metadata`);
            const data = await response.json();
            
            let html = `<div class="definition-info">
                            <p><strong>レコード数:</strong> ${data.row_count}行</p>
                            <p><strong>テーブル説明:</strong> ${data.table_comment || '説明なし'}</p>
                        </div>`;
            
            html += '<h4>カラム一覧</h4>';
            html += '<table class="definition-table">';
            html += '<tr><th>カラム名</th><th>データ型</th><th>説明</th></tr>';
            
            for (const column of data.columns) {
                html += `<tr>
                            <td><strong>${column.name}</strong></td>
                            <td>${column.type}</td>
                            <td>${column.comment || '説明なし'}</td>
                        </tr>`;
            }
            html += '</table>';
            
            document.getElementById('definitionContent').innerHTML = html;
        } catch (error) {
            document.getElementById('definitionContent').innerHTML = `<p>エラー: ${error.message}</p>`;
        }
    }
    
    async function loadTableData() {
        try {
            const response = await fetch(`/query/${tableName}?limit=100`);
            let data;
            try {
                data = await response.json();
            } catch (_) {
                throw new Error('サーバーからの応答をパースできませんでした');
            }

            if (!response.ok) {
                const msg = (data && data.detail) ? data.detail : `HTTP ${response.status}`;
                throw new Error(msg);
            }

            const rows = Array.isArray(data.data) ? data.data : [];

            let html = '';
            if (rows.length === 0) {
                html += '<p>データがありません。</p>';
            } else {
                html += '<table><tr>';
                for (const key in rows[0]) {
                    html += `<th>${key}</th>`;
                }
                html += '</tr>';
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    html += '<tr>';
                    for (const value of Object.values(row)) {
                        html += `<td>${value}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</table>';
            }

            document.getElementById('tableData').innerHTML = html;
        } catch (error) {
            document.getElementById('tableData').innerHTML = `<p>エラー: ${error.message}</p>`;
        }
    }
    
    function showResult(message, type) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
    }
    
    async function editTable(tableName) {
        window.location.href = `/table/${tableName}/edit`;
    }
    
    
    // ページ読み込み時にテーブルデータを表示
    loadTableData();
</script>
{% endblock %}
